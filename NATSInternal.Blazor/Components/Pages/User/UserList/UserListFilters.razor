@namespace NATSInternal.Blazor.Components
@inject IRoleService RoleService

<MainBlock title="Danh sách nhân viên" body-padding="2">
    <!-- Header -->
    <Header>
        @if (Model.CanCreate)
        {
            <NavLink to="/User/Create" class="btn btn-primary btn-sm">
                <i class="bi bi-plus-lg"></i>
                <span>Tạo mới</span>
            </NavLink>
        }
    </Header>

    <!-- Body -->
    <Body>
        <div class="row g-3">
            <!-- Search content -->
            <div class="col @SearchContentColumnClass">
                <div class="input-group">
                    <InputText class="flex-fill border-end-0" type="text"
                            maxlength="255" placeholder="Họ và tên, số điện thoại ..."
                            @bind-Value="Model.Content" @onchange="OnSearchContentChanged" />

                    <!-- Advance filters / collapse button -->        
                    <button class="btn btn-outline-primary" data-bs-toggle="collapse"
                            href="#advanced-filters-container" aria-expanded="fPrestalse"
                            role="button" aria-controls="advanced-filters-container">
                        <i class="bi bi-sliders"></i>
                    </button>
                </div>
                <span class="small opacity-50 @SearchContentValidationClass">
                    * Nội dung tìm kiếm phải chứa ít nhất 3 ký tự.
                </span>
            </div>

            <!-- Search button -->
            <div class="col col-auto">
                <button class="btn btn-primary" @onclick="OnSearchButtonClicked"
                        disabled="@IsSearchContentValid">
                    <i class="bi bi-search"></i>
                    <span class="d-sm-inline d-none ms-2">Tìm kiếm</span>
                </button>
            </div>
        </div>
        <div class="row g-3 collapse" id="advanced-filters-container">
            <!-- Order by field -->
            <div class="col col-sm-6 col-12">
                <InputLabel Name="Trường sắp xếp" />
                <SelectInput @bind-Value="Model.SortingByField">
                    <option value="@OrderByFieldOption.Name">
                        @DisplayNames.LastName
                    </option>
                    <option value="@OrderByFieldOption.FirstName">
                        @DisplayNames.FirstName
                    </option>
                    <option value="@OrderByFieldOption.UserName">
                        @DisplayNames.UserName
                    </option>
                    <option value="@OrderByFieldOption.Birthday">
                        @DisplayNames.Birthday
                    </option>
                    <option value="@OrderByFieldOption.Age">
                        @DisplayNames.Age
                    </option>
                    <option value="@OrderByFieldOption.CreatedDateTime">
                        @DisplayNames.CreatedDateTime
                    </option>
                    <option value="@OrderByFieldOption.Role">
                        @DisplayNames.Role
                    </option>
                </SelectInput>
            </div>

            <!-- Order by direction -->
            <div class="col col-sm-6 col-12">
                <InputLabel name="Thứ tự sắp xếp" />
                <SelectInput @bind-Value="Model.SortingByAscending">
                    <option value="@true">Từ nhỏ đến lớn</option>
                    <option value="@false">Từ lớn đến nhỏ</option>
                </SelectInput>
            </div>

            <!-- Role options -->
            <div class="col col-12 pb-0">
                <InputLabel name="Vị trí" />
                <div class="d-flex flex-row flex-wrap">
                    <!-- Specific role button -->
                    @foreach (RoleMinimalModel role in RoleOptions)
                    {
                        <div class="btn btn-sm me-2 mb-2 @RoleButtonClassName(role.Name)"
                                @onclick="@(e => OnRoleButtonClicked(role))">
                            @if (role.Id == 1)
                            {
                                <i class="bi bi-wrench"></i>
                            }
                            else if (role.Id == 2)
                            {  
                                <i class="bi bi-wrench"></i>
                            }
                            else
                            {
                                <i class="bi bi-star"></i>
                            }
                            <span class="ms-1">@role.DisplayName</span>
                        </div>
                    }
                </div>
            </div>
        </div>
    </Body>
</MainBlock>

@code {
    [Parameter]
    public UserListModel Model { get; set; }

    [Parameter]
    public EventCallback OnSearchButtonClicked { get; set; }

    private List<RoleMinimalModel> RoleOptions { get; set; }

    private bool IsSearchContentValid => Model.Content.Length == 0 ||
        Model.Content.Length >= 3;

    private string SearchContentColumnClass => !IsSearchContentValid ? "pb-0" : null;

    private string SearchContentValidationClass => !IsSearchContentValid ? "d-none" : null;

    protected override async Task OnInitializedAsync()
    {
        List<RoleMinimalResponseDto> responseDtos = await RoleService.GetAllAsync(); 
        RoleOptions = responseDtos.Select(dto => new RoleMinimalModel(dto)).ToList();
    }

    private string RoleButtonClassName(string roleName) {
        string color = RoleHelper.GetRoleBootstrapColor(roleName);
        return $"bg-{color} bg-opacity-10 border-{color}-subtle text-{color}";
    }

    private void OnSearchContentChanged(ChangeEventArgs _)
    {
        Model.Page = 1;
    }

    private void OnRoleButtonClicked(RoleMinimalModel role)
    {
        Model.Role = role;
    }
}
